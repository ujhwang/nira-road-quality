<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Atlanta Road Roughness & Anomalies (NIRA)</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .mapboxgl-popup {
            max-width: 400px !important;
            min-width: 250px;
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
        }

        #legend-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-family: 'Roboto', sans-serif;
            color: white;
        }

        .legend {
            background: rgba(0,0,0,0.7);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.6;
        }

        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 4px;
        }


    </style>
</head>
<body>
    <div id="map"></div>
    <div id="legend-container">
        <div class="legend" id="roughness-legend">
            <strong>Roughness (IRI in inch/mile)</strong><br>
            <span class="legend-color" style="background:#2DC937;"></span> 0–95<br>
            <span class="legend-color" style="background:#99C140;"></span> 95–130<br>
            <span class="legend-color" style="background:#E7B416;"></span> 130–170<br>
            <span class="legend-color" style="background:#DB7B2B;"></span> 170–220<br>
            <span class="legend-color" style="background:#CC3232;"></span> 220+
        </div>

        <div class="legend" id="anomaly-legend">
            <strong>Road Anomaly Types</strong><br>
            <label><input type="checkbox" value="POTHOLE" checked> 
                <span class="legend-color" style="background:#9442db;"></span> Pothole</label><br>
            <label><input type="checkbox" value="BUMP" checked> 
                <span class="legend-color" style="background:#17aceb;"></span> Bump</label><br>
            <label><input type="checkbox" value="OTHER" checked> 
                <span class="legend-color" style="background:#686869;"></span> Other</label>
        </div>

        <div class="legend" id="road-type-controls">
            <strong>Road Types (OSM)</strong><br>
            <label><input type="checkbox" value="motorway" checked> Motorway</label><br>
            <label><input type="checkbox" value="trunk" checked> Trunk</label><br>
            <label><input type="checkbox" value="primary" checked> Primary</label><br>
            <label><input type="checkbox" value="secondary" checked> Secondary</label><br>
            <label><input type="checkbox" value="tertiary" checked> Tertiary</label><br>
            <label><input type="checkbox" value="residential"> Residential</label>
        </div>
    </div>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js'></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" type="text/css">

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidWpod2FuZyIsImEiOiJjbHl4N2h5cTQxeXU1MmpvaWZ5bXNjdHpjIn0.gcfpTq4jsVV2E9yULpcJWQ';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [-84.4280, 33.8390],
            zoom: 9
        });

        function initializeMap() {
            map.on('load', function () {

                ///////// Road roughness
                // Vector tile source
                map.addSource('my-vector-tiles', {
                    type: 'vector',
                    url: 'mapbox://ujhwang.0oz70ei1'
                });

                // Main roughness layer
                map.addLayer({
                    'id': 'nira-roughness-layer',
                    'type': 'line',
                    'source': 'my-vector-tiles',
                    'source-layer': 'osmnx_edges_nira_joined-5czlx2',
                    'minzoom': 0,
                    'maxzoom': 24,
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': [
                            'step',
                            ['get', 'roughness_60_days'],
                            '#2DC937', // default for < 95
                            95, '#99C140',
                            130, '#E7B416',
                            170, '#DB7B2B',
                            220, '#CC3232'
                        ],
                        'line-width': 2
                    }
                });

                // Highlight layer (appears above main layer)
                map.addLayer({
                    'id': 'nira-roughness-highlight',
                    'type': 'line',
                    'source': 'my-vector-tiles',
                    'source-layer': 'osmnx_edges_nira_joined-5czlx2',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': [
                            'step',
                            ['get', 'roughness_60_days'],
                            '#2DC937', // default for < 95
                            95, '#99C140',
                            130, '#E7B416',
                            170, '#DB7B2B',
                            220, '#CC3232'
                        ],
                        'line-width': 10
                    },
                    'filter': ['==', ['get', 'id'], -1] // initially no highlight
                });

                // Tooltip setup
                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    offset: [0, -15]
                });

                map.on('mousemove', 'nira-roughness-layer', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    const f = e.features[0];
                    const { name, highway, roughness_60_days, id } = f.properties;

                    // Set highlight filter
                    map.setFilter('nira-roughness-highlight', ['==', ['get', 'id'], id]);

                    const desc = `
                        ${name || 'Unnamed road'}<br>
                        <em>${highway || 'Unknown type'}</em><br>
                        <strong>Roughness (past 60 days): ${roughness_60_days ? roughness_60_days.toFixed(0) : 'N/A'} in/mi</strong>
                    `;

                    popup.setLngLat(e.lngLat).setHTML(desc).addTo(map);
                });

                map.on('mouseleave', 'nira-roughness-layer', () => {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                    map.setFilter('nira-roughness-highlight', ['==', ['get', 'id'], -1]);
                });


                /////// Anomaly
                d3.json('data/geojson/anomaly_filtered.geojson').then(function(geojson) {

                    map.addSource('anomaly', {
                        type: 'geojson',
                        data: geojson,
                        cluster: true,      // enable clustering
                        clusterMaxZoom: 12, // max zoom to cluster points
                        clusterRadius: 50   // radius in pixels to group point
                    });

                    // Layer for clustered circles
                    map.addLayer({
                        id: "clusters",
                        type: "circle",
                        source: "anomaly",
                        filter: ["has", "point_count"], // only clusters
                        paint: {
                            "circle-color": [
                                "step",
                                ["get", "point_count"],
                                "#51bbd6",  // small clusters
                                50, "#f1f075", 
                                100, "#f28cb1",
                                1000, "#ff0000"
                            ],
                            "circle-radius": [
                                "step",
                                ["get", "point_count"],
                                13, 
                                50, 16,
                                100, 23,
                                1000, 30
                            ]
                        }
                    });

                    // Cluster count labels
                    map.addLayer({
                        id: "cluster-count",
                        type: "symbol",
                        source: "anomaly",
                        filter: ["has", "point_count"],
                        layout: {
                            "text-field": "{point_count_abbreviated}",
                            "text-font": ["Roboto Bold"],
                            "text-size": 12
                        }
                    });

                    map.on('click', 'clusters', function (e) {
                        const features = map.queryRenderedFeatures(e.point, {
                            layers: ['clusters']
                        });
                        const clusterId = features[0].properties.cluster_id;
                        map.getSource('anomaly').getClusterExpansionZoom(clusterId, function (err, zoom) {
                            if (err) return;
                            map.easeTo({
                                center: features[0].geometry.coordinates,
                                zoom: zoom+0.8
                            });
                        });
                    });

                    // Add a layer for highlighting clusters on hover
                    map.addLayer({
                        id: "clusters-highlight",
                        type: "circle",
                        source: "anomaly",
                        filter: ["==", "cluster_id", -1], // initially no highlight
                        paint: {
                            "circle-radius": [
                                "step",
                                ["get", "point_count"],
                                13, 
                                50, 16,
                                100, 23,
                                1000, 30
                            ],
                            "circle-color": "rgba(255,255,255,0)", // transparent fill
                            "circle-stroke-color": "#ffffff",     // white border
                            "circle-stroke-width": 3
                        }
                    });

                    // Mouse events for cluster hover
                    map.on("mouseenter", "clusters", (e) => {
                        map.getCanvas().style.cursor = "pointer";
                        const clusterId = e.features[0].properties.cluster_id;
                        map.setFilter("clusters-highlight", ["==", "cluster_id", clusterId]);
                    });

                    map.on("mouseleave", "clusters", () => {
                        map.getCanvas().style.cursor = "";
                        map.setFilter("clusters-highlight", ["==", "cluster_id", -1]);
                    });

                    // Unclustered anomaly point
                    map.addLayer({
                        id: "anomaly-layer",
                        type: "circle",
                        source: "anomaly",
                        filter: ["!", ["has", "point_count"]],
                        paint: {
                            "circle-radius": [
                                "step",
                                ["get", "severity"],
                                4,
                                2, 6, 
                                3, 8,  
                                4, 10, 
                                5, 12 
                            ],
                            "circle-color": [
                                "match",
                                ["get", "type"],
                                "POTHOLE", "#9442db",
                                "BUMP", "#17aceb",
                                "OTHER", "#686869",
                                "#999999"
                            ],
                            "circle-stroke-width": 1,
                            "circle-stroke-color": "#fff"
                        }
                    });

                    // Add highlight layer for unclustered anomaly points
                    map.addLayer({
                        id: "anomaly-highlight",
                        type: "circle",
                        source: "anomaly",
                        filter: ["==", ["get", "id"], ""], // initially no highlight
                        paint: {
                            "circle-radius": [
                                "step",
                                ["get", "severity"],
                                4+4,
                                2, 6+4, 
                                3, 8+4,  
                                4, 10+4, 
                                5, 12+4 
                            ],
                            "circle-color": [
                                "match",
                                ["get", "type"],
                                "POTHOLE", "#9442db",
                                "BUMP", "#17aceb",
                                "OTHER", "#686869",
                                "#999999"
                            ],
                            "circle-stroke-width": 2,
                            "circle-stroke-color": "#fff"
                        }
                    });

                    // Popup for anomaly
                    const popup = new mapboxgl.Popup({
                        closeButton: false,
                        closeOnClick: false,
                        offset: [0, -15]
                    });

                    let hoveredIncidentId = null;

                    map.on("mousemove", "anomaly-layer", (e) => {
                        map.getCanvas().style.cursor = "pointer";
                        const f = e.features[0];

                        hoveredIncidentId = f.id;

                        const props = f.properties;
                        const html = `
                            <strong>Type:</strong> ${props.type}<br>
                            <strong>Severity:</strong> ${props.severity}<br>
                            <strong>Hit ratio:</strong> ${(+props.hit_ratio).toFixed(2)}<br>
                            <strong>Direction:</strong> ${props.direction}<br>
                            <strong>First detection:</strong> ${props.first_detection}
                        `;
                        popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
                    });

                    // Mouse events for anomaly points
                    map.on("mouseenter", "anomaly-layer", (e) => {
                        map.getCanvas().style.cursor = "pointer";

                        // Use the property 'id' inside properties
                        const featureId = e.features[0].properties.id;

                        // Set filter using the property
                        map.setFilter("anomaly-highlight", ["==", ["get", "id"], featureId]);
                    });

                    map.on("mouseleave", "anomaly-layer", () => {
                        map.getCanvas().style.cursor = "";
                        map.setFilter("anomaly-highlight", ["==", ["get", "id"], -1]); 
                        popup.remove();
                    });

                    // Attach events to anomaly checkboxes
                    document.querySelectorAll('#anomaly-legend input[value="POTHOLE"], #anomaly-legend input[value="BUMP"], #anomaly-legend input[value="OTHER"]').forEach(cb => {
                        cb.addEventListener('change', updateAnomalyTypeFilter);
                    });

                    updateAnomalyTypeFilter();
                });

                /////// Filters
                // Function to update road type filter
                function updateRoadTypeFilter() {
                    const checkboxes = document.querySelectorAll('#road-type-controls input[type="checkbox"]');
                    const selected = Array.from(checkboxes)
                                        .filter(cb => cb.checked)
                                        .map(cb => cb.value);

                    // If none selected, show nothing
                    if (selected.length === 0) {
                        map.setFilter('nira-roughness-layer', ['in', 'highway', '']); 
                        map.setFilter('nira-roughness-highlight', ['==', ['get', 'id'], -1]);
                    } else {
                        map.setFilter('nira-roughness-layer', ['in', ['get', 'highway'], ['literal', selected]]);
                        map.setFilter('nira-roughness-highlight', ['==', ['get', 'id'], -1]);
                    }
                }

                // Attach change events to checkboxes
                document.querySelectorAll('#road-type-controls input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', updateRoadTypeFilter);
                });
                
                // Anomaly type filter
                function updateAnomalyTypeFilter() {
                    const checkboxes = document.querySelectorAll('#anomaly-legend input[value="POTHOLE"], #anomaly-legend input[value="BUMP"], #anomaly-legend input[value="OTHER"]');
                    const selected = Array.from(checkboxes)
                                        .filter(cb => cb.checked)
                                        .map(cb => cb.value);

                    if (selected.length === 0) {
                        map.setFilter('anomaly-layer', ['in', ['get', 'type'], ['literal', []]]);
                        map.setFilter('anomaly-highlight', ['==', ['get', 'id'], -1]);
                    } else {
                        map.setFilter('anomaly-layer', ['in', ['get', 'type'], ['literal', selected]]);
                        map.setFilter('anomaly-highlight', ['==', ['get', 'id'], -1]);
                    }
                }

                //////// County boundaries
                d3.json('data/geojson/21_counties.geojson').then(function(geojsonData) {
                    map.addSource('counties', {
                        type: 'geojson',
                        data: geojsonData
                    });

                    map.addLayer({
                        'id': 'counties-layer',
                        'type': 'line',
                        'source': 'counties',
                        'paint': {
                            'line-color': '#a3a2a2',
                            'line-width': 1,
                            'line-dasharray': [2, 2]
                        }
                    });

                    map.addLayer({
                        'id': 'counties-label',
                        'type': 'symbol',
                        'source': 'counties',
                        'layout': {
                            'text-field': ['get', 'NAME'],
                            'text-font': ['Roboto Bold', 'Arial Unicode MS Bold'],
                            'text-size': 18,
                            'text-anchor': 'center',
                            'symbol-placement': 'point', 
                            'text-allow-overlap': false 
                        },
                        'paint': {
                            'text-color': '#ffffff',
                            'text-halo-color': '#000000',
                            'text-halo-width': 1
                        },
                        'minzoom': 3,
                        'maxzoom': 11
                    });
                });

                // Initialize visibility filters based on checkbox states
                updateRoadTypeFilter();
                
            });
        }

        initializeMap();

        // Add the search box (geocoder)
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,  // same token used for map
            mapboxgl: mapboxgl,
            marker: false, // don't drop a marker automatically
            placeholder: "Search for a location", // placeholder text
            collapsed: false // keep open by default
        });

        // Add geocoder control to top-left corner
        map.addControl(geocoder, "top-left");

    </script>
</body>
</html>
